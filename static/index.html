<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>charm10jo</title>
        <!-- <link rel="stylesheet", href="https://unpkg.com/mvp.css"> -->
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
        crossorigin="anonymous"></script>
        <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=33750ee11a8868880609595a70a3f256&libraries=services"></script>
    <script>fetch("https://jsonplaceholder.typicode.com/posts/1").then((response) =>
  console.log(response)
    );</script>
        <script src="map.js"></script>
        <script src="translating.js"></script>
        <script src="available.js"></script>
        <script src="lang.js"></script>
        <script src="index.js"></script>
        <link rel="stylesheet" href="index.css">
        
    </head>
    <body>
        <header id="header">
            <h1> Welcome! </h1>
            <h3> These are our supporting languages. </h3>
            <h4> English, Chinese, Vietnamese, Mongolian, Thai, Russian, Kazaht, Japanese. </h4>
        </header>

        <main>
            <div id="loginPage">
                <h2>Login Page</h2>
                <h3>If you don't need to signup, click "Just Keep Going" Button plz.</h3>
                <form id="loginForm_login">
                    <div>
                        <div>
                            <label style="font-size: 20px;">nickname : <input style="height: 25px;" id="nick", required, type="text", name="login_user"></label>
                            <label style="font-size: 20px;">password : <input style="height: 25px;" id="password", required, type="password", name="login_user"></label>
                        </div>
                        <button id="loginBtn" onclick="login(event)">Login</button>
                    </div>
                    <div class="loginForm_button">
                        <button id="loginForm_signup" onclick="gosignupFrom(event)">SignUp</button>
                        <button id="loginForm_JKG" onclick="notlogin(event)">Just Keep Going</button>
                    </div>
                </form>
            </div>

            <div id="signupPage">
                <h2>SignUp</h2>
                <form>
                    
                    <input id="sign_nick", required, type="text", name="sign_user" placeholder="nick name">
                    <input id="sign_password", required, type="password", name="sign_user" placeholder="password">
                    <input id="sign_confirmPassword", required, type="password", name="sign_user" placeholder="Confirm Password">
                    <input id="userName", type="text", name="userName" placeholder="Name">
                    <input id="Phone", type="text", name="phone" placeholder="PhoneNumber">
                    <input id="birth", type="date", name="birth" placeholder="Birthday">

                    <div class="gender_div">
                        <h3>gender : </h3>
                        <label><input id="gender_male", type="radio", name="gender", value="1"> male</label>
                        <label><input id="gender_female", type="radio", name="gender", value="2"> female</label>
                        <label><input id="gender_others", type="radio", name="gender", value="3" checked="false"> other</label>
                    </div>
                    
                    <!-- <input id="living", type="text", name="livingAt" placeholder="Living At"> -->
                    <div class="checkbox">
                        <h3>Korean Insurance</h3><input id="KI", type="checkbox", name="KI", checked="false">
                    </div>
                    <div class="checkbox">
                        <h3>Private Insurance</h3><input id="PI", type="checkbox", name="PI", checked="false">
                    </div>
                    
                    <button id="signupButton">Done</button>
                </form>
            </div>
            <div id="welcome">
                <form>
                    <h2>Choose your language</h2>
                    <div id="Languages">
                        <div>
                            <label><input required, type="radio", name="langs", value="en">English</label>
                            <label> <input required, type="radio", name="langs", value="zh-TW">Chinese: Traditional</label>
                            <label> <input required, type="radio", name="langs", value="zh-CN">Chinese: Simplified</label>
                        </div>
                        <div>
                            <label> <input required, type="radio", name="langs", value="vi">Vietnamese</label>
                            <label> <input required, type="radio", name="langs", value="mn">Mongolian</label>
                            <label> <input required, type="radio", name="langs", value="th">Thai</label>
                            <label> <input required, type="radio", name="langs", value="ru">Russian</label>
                            <label> <input required, type="radio", name="langs", value="kk">Kazakh</label>
                            <label> <input required, type="radio", name="langs", value="ja">Japanese</label>
                        </div>
                    </div>
                    <button>Enter Room</button>
                </form>
            </div>

            <div id="room">
                <ul>
                    
                </ul>
                <form id="msg">
                    <textarea id="Symptoms" placeholder="Symptoms" required name="Symptoms"></textarea>
                    <!-- <input required, type="text", name="division", placeholder="divisions"> -->
                    <h3>Necessary Medical Measures</h3>
                    <div>
                        <label for="NMM1"><input id="NMM1", required, type="radio", name="NMM", value="1" checked>just some medicines</label>
                        <label for="NMM2"><input id="NMM2", required, type="radio", name="NMM", value="2">need Doctor's medical measures</label>
                        <label for="NMM3"><input id="NMM3", required, type="radio", name="NMM", value="3">Emergency Room</label>
                    </div>
                    <h3>Searching Priority</h3>
                    <div>
                        <label for="EL1"><input id="EL1", required, type="radio", name="EL", value="1" checked>Near Distance</label>
                        <label for="EL2"><input id="EL2", required, type="radio", name="EL", value="2">Support your Language</label>
                    </div>
                    <button>Send</button>
                </form>
            </div>
        </main>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs" crossorigin="anonymous"></script><script></script>
    <script>    
        const socket = io('/chat')
        // const socket = io('http://localhost:3333/chat');

        const welcome = document.getElementById("welcome");
        const form = welcome.querySelector("form");
        const room = document.getElementById("room");
        const signup = document.getElementById("signupPage");
        const signupForm = signup.querySelector("form");

        let roomName;
        let mapId =0;

        function createMapDiv(mapId, data, trdText){
            // <div id="map" style="width:100%;height:350px;"></div>
            let data_division = data.division.split(',');
            let translateDivision = [];
            let supportLanguages = [];
            console.log(data)


            for(let e of data_division){
                translateDivision.push(translate_division(translat_lang,e.trim()))
            }

            const ul = room.querySelector("ul");

            let temp = `
                <li class="bot_message">
                    <div id="map${mapId}" style="width:100%;height:350px;"></div>
                </li>`;
            const li = document.createElement("li");
            
            li.classList = "bot_message";
            
            const div = document.createElement("div");
            div.id = `map${mapId}`;
            div.style = "width:90%;height:350px;";

            const botdiv = document.createElement("div");
            botdiv.innerText = 'Bot : \n'
            botdiv.style = "font-size:20px"

            li.appendChild(botdiv);
            li.appendChild(div);
            
            console.log(data)
            // bot msg
            const botli = document.createElement("li");
            const forr = foreignLang(data);
            const bot_forr = [];
            console.log(forr)
            if(forr === "Only Korean"){
                bot_forr.push(support_languages(translat_lang,forr));
            }else{
                for(let e of forr){
                    bot_forr.push(support_languages(translat_lang,e.trim()));
                }
            }
            
            console.log(bot_forr)

            botli.innerText = `
                    ${send_form.bot_translation} : ${trdText}
                    ${send_form.bot_hospital_name} : ${data.hospitalName}
                    ${send_form.bot_hospital_addr} : ${data.address}
                    ${send_form.bot_medical_department} : ${translateDivision.join(',')}
                    ${send_form.bot_language} : ${bot_forr.join(",")}
                `;
                
            li.appendChild(botli);

            // addbtu
            // const br = document.createElement('br');

            let a = document.createElement("a");
            a.href = `https://map.kakao.com/?sName=${myaddress}&eName=${data.address}`;
            a.innerText = `<${send_form.bot_route}>`; 
            a.setAttribute('target','_blank');
            li.appendChild(a);

            a = document.createElement("a");
            a.href = '#';
            a.innerText = `<${send_form.bot_retry}>`;
            a.setAttribute('onclick','handleMessageSubmit(event,true)');
            li.appendChild(a);


            ul.appendChild(li);

        }

        function foreignLang(str) {
            let langs = [];
            const languageObj ={
                English:str.language1Englsh,
                ChineseCN:str.language2ChineseCN,
                ChineseTW:str.language3ChineseTW,
                Vietnamese:str.language4Vietnamese,
                Mongolian:str.language5Mongolian,
                Thai:str.language6Thai,
                Russian:str.language7Russian,
                Kazakh:str.language8Kazakh,
                Japanese:str.language9Japanese
            } 
            
            for(let e in languageObj){
                if(languageObj[e] === 1) langs.push(e);
            }
            
            if(langs.length == 0){
                return "Only Korean";
            }else {
                return langs;
            }

        }

        

        function handleMessageSubmit(event,retry) {
            event.preventDefault();
            const s = $("#Symptoms").val() //room.querySelector(`#msg textarea[name="Symptoms"]`).value;

            const nmm = room.querySelector(`#msg input[name="NMM"]:checked`).value;
            const priority = room.querySelector(`#msg input[name="EL"]:checked`).value;
            const language = socket['lang'];
            
            // 이거는 캐시서버에서 무조건 ai 태울때 사용하려고 했던거심 ..
            if(typeof retry === 'undefined') retry = false;
            if(s === ''){
                $("#Symptoms").focus();
                return false;
            }

            const data = {
                // division: d,
                symptoms: s,
                nmm,
                priority,
                language,
                latitude,
                longitude,
                retry
            };
                    

            socket.emit("botMessage", data);

            
            const ul = room.querySelector("ul");
            const li = document.createElement("li");
            li.classList = "client_message";
            li.innerText = s;
            ul.appendChild(li);
        }

        
        function showRoom(roomName, langVal) {
            $('#welcome').hide();
            $('#room').show();
            $('#msg').show();
            const h3 = room.querySelector("h3");
            h3.innerText = `Room ${roomName}`;
            const msgForm = room.querySelector("#msg");
            msgForm.addEventListener("submit", handleMessageSubmit);
        }

        function handleRoomSubmit(event) {
            try {
                event.preventDefault();
                const langVal = form.querySelector(`input[name="langs"]:checked`).value;
                const lang = form.querySelector(`input[name="langs"]:checked`).parentElement.innerText;

                roomName = lang;
                socket['lang'] = langVal;
                
                // 언어에 따라서 화면 언어 수정
                change_lang(langVal);
                change_form();
                showRoom(roomName);   
            } catch (error) {
                alert('check the options!')
            }
            
        }

        form.addEventListener("submit", handleRoomSubmit);

        signupForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const Id = signupForm.querySelector('#sign_nick').value
            const password = signupForm.querySelector('#sign_password').value
            const confirm = signupForm.querySelector('#sign_confirmPassword').value
            const gender = signupForm.querySelector(`input[name="gender"]:checked`).value || null
            const birthday = signupForm.querySelector('#birth').value || null
            let korIns = false
            if(signupForm.querySelector('input[name="KI"]:checked')){
                korIns = true
            }
            let privIns = false
            if(signupForm.querySelector('input[name="PI"]:checked')){
                privIns = true
            } 
            const phoneNumber = Number(signupForm.querySelector('#Phone').value) || null
            const name = signupForm.querySelector('#userName').value || null
            
            // id 유효성 검사
            if(!id_value(Id)) return false;
            // pwd 유효성 검사
            if(!pwd_value(password,confirm)) return false;

            const data = {
                Id,
                password,
                confirm,
                gender: Number(gender),
                // livingAt,
                birthday,
                korIns,
                privIns,
                phoneNumber,
                name
            };

            socket.emit('signup', data);
        });

        socket.on("welcome", (lang) => {

            const h3 = room.querySelector("h3");
            h3.innerText = `Room ${lang}`;

            
            // addMessage(`${user} arrived!`);
        });

        socket.on("bye", () => {
            const h3 = room.querySelector("h3");
            h3.innerText = `Room ${roomName}`;
            // addMessage(`${left} left.`);
        });

        socket.on("login", (res) => {
            if(res !== '401'){
                const { success, token } = res;
                window.sessionStorage.setItem("token", token);

                document.getElementById("loginPage").style.display = 'none';
                document.getElementById("welcome").style.display = 'block';

                const header = document.getElementById("header");
                const h1 = header.querySelector("h1")

                h1.innerText = `Welcome ${res.nick}!`;
                alert(`Hello ${res.nick} !`);
            }else{
                alert('Check your ID or password!');
            }
        });

        socket.on("signup", (result) => {
            if(result === true){
                alert("Hello !");
                document.getElementById("signupPage").style.display = 'none';
                document.getElementById("loginPage").style.display = 'block';
            }else if(result === '409'){
                alert('You are already a registered member!');
                $("#sign_nick").focus();
                return false
            }else{
                alert('Check out the membership registration form!');
                $("#sign_nick").focus();
                return false
            }
        });
        
        socket.on("botMessage", async (res,trdText) => {

            let myAddrArray = {x:latitude, y:longitude}

            // NaN 으로 나오는 건 소켓과 웹브라우저의 통신에서 데이터 변환이 이루어지기 때문이다 ?
            // 메소드 반복 -> 비동기 처리 x 
            // for문은 하나하나 기다린다 

            for (let e in res){
                let test = await coordinate(res[e].address);
                res[e] = {...test, ...res[e]}
            }
            
            let sortAddrArray = res.filter((e)=>{ return e.status === "OK" ? 1 : 0}).sort((a,b)=> a.distance > b.distance ? 1 : a.distance < b.distance ? -1 : 0 );

        setTimeout(() => {
                createMapDiv(mapId,sortAddrArray[0], trdText);
                drawMap(sortAddrArray, mapId, myAddrArray);
                mapId ++;
            }, 150);
        });
        </script>
    </body>
</html>